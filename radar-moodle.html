<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #1a535c;
      --accent-color: #4ecdc4;
      --bg-color: #f7f9fc;
      --text-color: #2c3e50;
    }
    body { font-family: 'Roboto', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; }
    
    .container {
      max-width: 800px; margin: 0 auto; background: white;
      padding: 30px; border-radius: 15px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.05);
    }

    h1 { text-align: center; color: var(--primary-color); font-size: 1.8rem; margin-bottom: 5px; }
    .date-badge { text-align: center; font-size: 0.9rem; color: #7f8c8d; margin-bottom: 30px; }

    .chart-wrapper {
      position: relative; height: 350px; width: 100%; margin-bottom: 40px;
    }

    .levers-list { display: flex; flex-direction: column; gap: 15px; }
    
    .lever-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 15px; border-radius: 8px; background: #fff;
      border: 1px solid #edf2f7;
    }
    
    .lever-info { flex: 1; padding-right: 15px; }
    .lever-name { font-weight: 500; font-size: 1rem; margin-bottom: 5px; }
    
    .lever-visual { width: 40%; max-width: 200px; }
    .score-val { text-align: right; font-weight: 700; font-size: 1.1rem; color: var(--primary-color); }
    
    .progress-track {
      background-color: #e2e8f0; height: 8px; border-radius: 4px;
      overflow: hidden; margin-top: 5px;
    }
    .progress-fill { height: 100%; transition: width 1s ease-out; }

    .low { background-color: #e74c3c; }
    .med { background-color: #f1c40f; }
    .high { background-color: #27ae60; }

    .hidden { display: none; }
    .loader { text-align: center; padding: 40px; color: #bdc3c7; }
    .error-box { background: #fee2e2; color: #c0392b; padding: 15px; border-radius: 8px; text-align: center; }
    
    .welcome-box { 
      background: linear-gradient(135deg, #e8f5f3 0%, #d4edea 100%); 
      color: var(--primary-color); 
      padding: 40px 30px; 
      border-radius: 12px; 
      text-align: center;
      border: 1px solid #b8ddd6;
    }
    .welcome-box h2 { margin: 0 0 15px 0; font-size: 1.4rem; }
    .welcome-box p { margin: 0; font-size: 1rem; line-height: 1.6; color: #4a6670; }
    .welcome-icon { font-size: 3rem; margin-bottom: 15px; }

    /* Bouton actualiser et status */
    .refresh-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 10px 15px;
      background: #f0f4f5;
      border-radius: 8px;
      font-size: 0.85rem;
    }
    .refresh-status {
      color: #7f8c8d;
    }
    .refresh-status.updating {
      color: var(--primary-color);
    }
    .refresh-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .refresh-btn:hover {
      background: #2d6a73;
      transform: translateY(-1px);
    }
    .refresh-btn:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      transform: none;
    }
    .refresh-btn .spinner-small {
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>R√©sultats Autodiagnostic</h1>
    <div id="dateTag" class="date-badge">Chargement...</div>

    <div id="loader" class="loader">Analyse des donn√©es en cours...</div>
    <div id="error" class="error-box hidden"></div>
    <div id="welcome" class="welcome-box hidden">
      <div class="welcome-icon">üìã</div>
      <h2>Bienvenue dans l'autodiagnostic</h2>
      <p>Vous n'avez pas encore compl√©t√© l'autodiagnostic.<br>
      Veuillez d'abord r√©pondre au questionnaire pour visualiser vos r√©sultats.</p>
    </div>

    <div id="content" class="hidden">
      <div class="refresh-bar">
        <span class="refresh-status" id="refreshStatus">Derni√®re mise √† jour : maintenant</span>
        <button class="refresh-btn" id="refreshBtn" onclick="manualRefresh()">
          üîÑ Actualiser
        </button>
      </div>
      <div class="chart-wrapper">
        <canvas id="radarChart"></canvas>
      </div>

      <hr style="border:0; border-top:1px solid #eee; margin: 30px 0;">

      <div id="jauges" class="levers-list">
      </div>
    </div>
  </div>

  <script>
    // =============================================================================
    // CONFIGURATION - √Ä MODIFIER
    // =============================================================================
    
    // URL du Google Sheet publi√© (Fichier > Partager > Publier sur le web > CSV)
    // REMPLACE CETTE URL par la tienne !
    var SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSIf4mDGh91M6e3WmbmsU9TrwBeJ3aSNhcplGIEGRVCXsOCrphvm0OGULQrSsRcT6zCrkYiioLwpa_v/pub?gid=80915653&single=true&output=csv";
    
    // R√©cup√®re l'email depuis l'URL (pass√© par Moodle via {email})
    var userEmail = getUrlParameter('email');
    
    // Variables globales pour le refresh
    var radarChart = null;
    var lastDataHash = null;
    var autoRefreshInterval = null;
    var autoRefreshCount = 0;
    var AUTO_REFRESH_DELAY = 30000; // 30 secondes
    var AUTO_REFRESH_MAX = 10; // Arr√™ter apr√®s 10 tentatives (5 minutes)
    
    // Configuration des leviers (doit correspondre aux en-t√™tes de ta feuille Scores)
    var LEVERS = [
      { id: "lev_02", label: "Alternance des p√©riodes de semis et des cultures" },
      { id: "lev_03", label: "Alternance des methodes d'implantation" },
      { id: "lev_04", label: "Optimisation de la competitivite de la culture" },
      { id: "lev_05", label: "R√©duction du stock semencier en interculture" },
      { id: "lev_06", label: "R√©duction du stock d'organes souterrains en interculture" },
      { id: "lev_07", label: "Couverture en interculture" },
      { id: "lev_08", label: "Interception des semences en culture avant le retour au sol" },
      { id: "lev_09", label: "R√©duction des contaminations" },
      { id: "lev_10", label: "D√©sherbage m√©canique" },
      { id: "lev_11", label: "D√©sherbage chimique" }
    ];

    // =============================================================================
    // CODE PRINCIPAL
    // =============================================================================

    function getUrlParameter(name) {
      var urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name) || "";
    }

    window.onload = function() {
      if (!userEmail) {
        showWelcome();
        return;
      }
      
      // Charger les donn√©es depuis le Google Sheet publi√©
      Papa.parse(SHEET_CSV_URL, {
        download: true,
        header: false,
        complete: function(results) {
          processData(results.data);
        },
        error: function(err) {
          showError("Impossible de charger les donn√©es : " + err.message);
        }
      });
    };

    function processData(data) {
      if (!data || data.length < 4) {
        showError("Donn√©es insuffisantes dans la feuille Scores.");
        return;
      }

      // Ligne 1 = Leviers (en-t√™tes)
      // Ligne 2 = Num√©ros de questions  
      // Ligne 3 = Intitul√©s des questions
      // Ligne 4+ = Donn√©es
      
      var headers = data[0];  // Noms des leviers
      var emailColIndex = findEmailColumn(headers);
      
      if (emailColIndex === -1) {
        showError("Colonne Email introuvable.");
        return;
      }

      // Chercher la ligne de l'utilisateur (la plus r√©cente = depuis la fin)
      var studentRow = null;
      for (var i = data.length - 1; i >= 3; i--) {
        var row = data[i];
        if (row[emailColIndex] && row[emailColIndex].toString().trim().toLowerCase() === userEmail.trim().toLowerCase()) {
          studentRow = row;
          break;
        }
      }

      if (!studentRow) {
        showWelcome();
        return;
      }

      // Agr√©ger les scores par levier
      var leverScores = {};
      LEVERS.forEach(function(l) { leverScores[l.label] = 0; });

      for (var col = 0; col < headers.length; col++) {
        var headerName = headers[col] ? headers[col].toString().trim() : "";
        if (leverScores.hasOwnProperty(headerName)) {
          var val = parseFloat(studentRow[col]) || 0;
          leverScores[headerName] += val;
        }
      }

      // Pr√©parer les r√©sultats
      var results = LEVERS.map(function(l) {
        var score = Math.round(leverScores[l.label]);
        if (score > 100) score = 100;
        if (score < 0) score = 0;
        return { label: l.label, score: score };
      });

      // Date (premi√®re colonne)
      var dateStr = studentRow[0] || "Date inconnue";

      showResults(results, dateStr);
    }

    function findEmailColumn(headers) {
      for (var i = 0; i < headers.length; i++) {
        if (headers[i] && headers[i].toString().toLowerCase().indexOf("mail") > -1) {
          return i;
        }
      }
      return 1; // Fallback colonne B
    }

    function showResults(results, dateStr) {
      document.getElementById('loader').classList.add('hidden');
      document.getElementById('dateTag').innerText = "Derni√®re √©valuation le " + dateStr;

      var labels = [];
      var dataScores = [];
      var html = "";

      results.forEach(function(r) {
        labels.push(shortLabel(r.label));
        dataScores.push(r.score);

        var color = r.score < 33 ? 'low' : (r.score < 66 ? 'med' : 'high');

        html += '<div class="lever-item">' +
                  '<div class="lever-info">' +
                    '<div class="lever-name">' + escapeHtml(r.label) + '</div>' +
                  '</div>' +
                  '<div class="lever-visual">' +
                    '<div class="score-val">' + r.score + '%</div>' +
                    '<div class="progress-track">' +
                      '<div class="progress-fill ' + color + '" style="width: ' + r.score + '%"></div>' +
                    '</div>' +
                  '</div>' +
                '</div>';
      });

      document.getElementById('jauges').innerHTML = html;
      document.getElementById('content').classList.remove('hidden');

      drawRadar(labels, dataScores);
    }

    function drawRadar(labels, data) {
      // Si le graphique existe d√©j√†, le mettre √† jour
      if (radarChart) {
        radarChart.data.labels = labels;
        radarChart.data.datasets[0].data = data;
        radarChart.update();
        return;
      }
      
      // Sinon, cr√©er un nouveau graphique
      var ctx = document.getElementById('radarChart').getContext('2d');
      radarChart = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Performance (%)',
            data: data,
            backgroundColor: 'rgba(26, 83, 92, 0.2)',
            borderColor: '#1a535c',
            pointBackgroundColor: '#1a535c',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            r: {
              min: 0, max: 100,
              ticks: { stepSize: 20, display: false },
              pointLabels: { font: { size: 11 } }
            }
          },
          plugins: { legend: { display: false } }
        }
      });
    }

    function shortLabel(str) {
      return str.length > 25 ? str.substring(0, 23) + "..." : str;
    }

    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showWelcome() {
      document.getElementById('loader').classList.add('hidden');
      document.getElementById('dateTag').classList.add('hidden');
      document.getElementById('welcome').classList.remove('hidden');
    }

    function showError(msg) {
      document.getElementById('loader').classList.add('hidden');
      document.getElementById('dateTag').classList.add('hidden');
      var div = document.getElementById('error');
      div.innerText = "Erreur : " + msg;
      div.classList.remove('hidden');
    }

    // =============================================================================
    // FONCTIONS DE MISE √Ä JOUR AUTOMATIQUE
    // =============================================================================

    function manualRefresh() {
      var btn = document.getElementById('refreshBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-small"></span> Actualisation...';
      
      updateStatus("Actualisation en cours...", true);
      
      refreshData(function() {
        btn.disabled = false;
        btn.innerHTML = 'üîÑ Actualiser';
      });
    }

    function refreshData(callback) {
      Papa.parse(SHEET_CSV_URL, {
        download: true,
        header: false,
        complete: function(results) {
          processDataForRefresh(results.data);
          if (callback) callback();
        },
        error: function(err) {
          updateStatus("Erreur de mise √† jour", false);
          if (callback) callback();
        }
      });
    }

    function processDataForRefresh(data) {
      if (!data || data.length < 4) {
        updateStatus("Donn√©es insuffisantes", false);
        return;
      }

      var headers = data[0];
      var emailColIndex = findEmailColumn(headers);
      
      if (emailColIndex === -1) {
        updateStatus("Erreur de configuration", false);
        return;
      }

      // Chercher la ligne de l'utilisateur
      var studentRow = null;
      for (var i = data.length - 1; i >= 3; i--) {
        var row = data[i];
        if (row[emailColIndex] && row[emailColIndex].toString().trim().toLowerCase() === userEmail.trim().toLowerCase()) {
          studentRow = row;
          break;
        }
      }

      if (!studentRow) {
        // Pas encore de donn√©es - afficher welcome si pas d√©j√† affich√©
        if (!document.getElementById('welcome').classList.contains('hidden')) {
          updateStatus("En attente de vos r√©sultats...", false);
        }
        return;
      }

      // Calculer un hash simple pour d√©tecter les changements
      var newHash = studentRow.join('|');
      
      if (newHash === lastDataHash) {
        // Pas de changement
        updateStatus("Aucune nouvelle donn√©e", false);
        return;
      }

      // Nouvelles donn√©es d√©tect√©es !
      lastDataHash = newHash;

      // Agr√©ger les scores par levier
      var leverScores = {};
      LEVERS.forEach(function(l) { leverScores[l.label] = 0; });

      for (var col = 0; col < headers.length; col++) {
        var headerName = headers[col] ? headers[col].toString().trim() : "";
        if (leverScores.hasOwnProperty(headerName)) {
          var val = parseFloat(studentRow[col]) || 0;
          leverScores[headerName] += val;
        }
      }

      // Pr√©parer les r√©sultats
      var results = LEVERS.map(function(l) {
        var score = Math.round(leverScores[l.label]);
        if (score > 100) score = 100;
        if (score < 0) score = 0;
        return { label: l.label, score: score };
      });

      // Mettre √† jour l'affichage
      var dateStr = studentRow[0] || "Date inconnue";
      
      // Si on vient du welcome, afficher le content
      if (!document.getElementById('content').classList.contains('hidden') === false) {
        document.getElementById('welcome').classList.add('hidden');
        document.getElementById('content').classList.remove('hidden');
      }
      
      showResults(results, dateStr);
      updateStatus("Mis √† jour !", false);
      
      // Arr√™ter l'auto-refresh si on a trouv√© des donn√©es
      if (autoRefreshInterval && !document.getElementById('welcome').classList.contains('hidden')) {
        // Continuer l'auto-refresh m√™me apr√®s avoir trouv√© des donn√©es
        // pour d√©tecter les mises √† jour futures
      }
    }

    function updateStatus(message, isUpdating) {
      var status = document.getElementById('refreshStatus');
      status.textContent = message;
      status.className = isUpdating ? 'refresh-status updating' : 'refresh-status';
      
      // R√©initialiser le message apr√®s quelques secondes
      if (!isUpdating) {
        setTimeout(function() {
          var now = new Date();
          status.textContent = "Derni√®re v√©rification : " + now.toLocaleTimeString('fr-FR');
        }, 2000);
      }
    }

    function startAutoRefresh() {
      // D√©marrer l'auto-refresh
      autoRefreshInterval = setInterval(function() {
        autoRefreshCount++;
        
        if (autoRefreshCount >= AUTO_REFRESH_MAX) {
          stopAutoRefresh();
          updateStatus("Auto-refresh arr√™t√©", false);
          return;
        }
        
        updateStatus("V√©rification automatique...", true);
        refreshData(function() {
          // Callback apr√®s refresh
        });
      }, AUTO_REFRESH_DELAY);
    }

    function stopAutoRefresh() {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
      }
    }

    // D√©marrer l'auto-refresh au chargement de la page
    window.addEventListener('load', function() {
      // Petit d√©lai pour laisser le temps au premier chargement
      setTimeout(function() {
        startAutoRefresh();
      }, 5000);
    });

    // Arr√™ter l'auto-refresh quand l'utilisateur quitte la page
    window.addEventListener('beforeunload', function() {
      stopAutoRefresh();
    });
  </script>
</body>
</html>
